<!doctype html>
<html lang="en"
      data-th-replace="~{base :: parent(~{::#content}, ~{::title}, ~{::script})}"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Contacts | Smart Contact Manager</title>
</head>

<body>

<div id="content" class="bg-gray-50 dark:bg-gray-900 min-h-screen">

    <!-- Sidebar -->
    <div data-th-if="${loggedInUser}">
        <div data-th-replace="~{user/sidebar :: sidebar}"></div>
    </div>

    <!-- Page Body -->
    <div class="sm:pl-64 pt-24 pb-16">

        <div class="max-w-7xl mx-auto px-6">

            <!-- Page Header -->
            <div class="mb-10 flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white">
                        All Contacts
                    </h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-300">
                        Manage, search, export & organize your contacts.
                    </p>
                </div>

                <button th:onclick="exportData()"
                        class="px-5 py-3 rounded-xl bg-green-600 hover:bg-green-700
                               text-white font-semibold shadow transition">
                    Export Contacts
                </button>
            </div>

            <!-- Search + Filter -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6 mb-8">

                <form th:object="${contactSearchForm}"
                      th:action="@{'/user/contacts/search'}"
                      class="flex flex-col md:flex-row gap-4 items-center">

                    <!-- Select -->
                    <select th:field="*{field}"
                            class="w-full md:w-48 rounded-lg border px-4 py-3
                                   bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <option value="">Select filter</option>
                        <option value="name">Name</option>
                        <option value="phone">Phone</option>
                        <option value="email">Email</option>
                    </select>

                    <!-- Search -->
                    <input th:field="*{value}"
                           type="text"
                           placeholder="Search contacts..."
                           class="w-full md:flex-1 rounded-lg border px-4 py-3
                                  bg-gray-50 dark:bg-gray-700 dark:border-gray-600">

                    <button type="submit"
                            class="px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700
                                   text-white font-semibold shadow transition">
                        Search
                    </button>

                </form>

            </div>

            <!-- Contacts Table -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow overflow-hidden">

                <table id="contact-table"
                       th:if="${pageContact.totalElements > 0}"
                       class="w-full text-sm text-left text-gray-600 dark:text-gray-300">

                    <thead class="bg-gray-100 dark:bg-gray-700 text-xs uppercase">
                        <tr>
                            <th class="px-6 py-4">Contact</th>
                            <th class="px-6 py-4">Phone</th>
                            <th class="px-6 py-4">Links</th>
                            <th class="px-6 py-4">Favourite</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr th:each="c : ${pageContact.content}"
                            class="border-t hover:bg-gray-50 dark:hover:bg-gray-700 transition">

                            <!-- Contact -->
                            <td class="px-6 py-4 flex items-center gap-3">
                                <img th:src="${c.picture != null ? c.picture : 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRsb1XJPz_AjTBJO7HaYD-yzPdQAvX_WtHeoWEay4Mx_ld75WReQKOCZcY&s'}"
                                     class="w-10 h-10 rounded-full object-cover"
                                     alt="contact image">

                                <div>
                                    <p class="font-semibold text-gray-900 dark:text-white"
                                       th:text="${c.name}"></p>
                                    <p class="text-xs text-gray-500"
                                       th:text="${c.email}"></p>
                                </div>
                            </td>

                            <!-- Phone -->
                            <td class="px-6 py-4" th:text="${c.phoneNumber}"></td>

                            <!-- Links -->
                            <td class="px-6 py-4 flex gap-3">
                                <a th:href="${c.websiteLink}" target="_blank">
                                    <i class="fa-solid fa-globe text-lg"></i>
                                </a>
                                <a th:href="${c.linkedinLink}" target="_blank">
                                    <i class="fa-brands fa-linkedin text-lg"></i>
                                </a>
                            </td>

                            <!-- Favourite -->
                            <td class="px-6 py-4">
                                <i th:class="${c.favourite ?
                                    'fa-solid fa-heart text-red-500' :
                                    'fa-regular fa-heart text-gray-400'}"></i>
                            </td>

                            <!-- Actions -->
                            <td class="px-6 py-4 text-center flex justify-center gap-4">
                                <button th:onclick="loadContactdata([[${c.id}]])">
                                    <i class="fa-regular fa-eye"></i>
                                </button>
                                <a data-th-href="@{'/user/contacts/view/' + ${c.id}}">
                                    <i class="fa-regular fa-pen-to-square"></i>
                                </a>
                                <button th:onclick="deleteContact([[${c.id}]])">
                                    <i class="fa-solid fa-trash text-red-500"></i>
                                </button>
                            </td>

                        </tr>
                    </tbody>
                </table>

                <!-- Empty State -->
                <div th:if="${pageContact.totalElements <= 0}"
                     class="p-10 text-center text-gray-600 dark:text-gray-300">
                    No contacts found.
                </div>

            </div>

            <!-- Pagination -->
            <div th:if="${pageContact.totalElements > 0}"
                 class="mt-8 flex flex-wrap justify-center items-center gap-6">

                <div class="flex items-center gap-2">
                    <label class="text-sm">Contacts per page</label>
                    <select onchange="changePageSize(this.value)"
                            th:value="${pageSize}"
                            class="rounded-lg border px-3 py-2 dark:bg-gray-700">
                        <option th:value="5" th:selected="${pageSize==5}">5</option>
                        <option th:value="10" th:selected="${pageSize==10}">10</option>
                        <option th:value="20" th:selected="${pageSize==20}">20</option>
                        <option th:value="50" th:selected="${pageSize==50}">50</option>
                    </select>
                </div>

                <nav>
                    <ul class="inline-flex rounded-lg overflow-hidden border">
                        <li th:unless="${pageContact.first}">
                            <a th:href="@{'/user/contacts?size='+${pageSize}+'&page='+${pageContact.number-1}}"
                               class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Prev
                            </a>
                        </li>

                        <li th:each="i : ${#numbers.sequence(0, pageContact.totalPages-1)}">
                            <a th:href="@{'/user/contacts?size='+${pageSize}+'&page='+${i}}"
                               th:classappend="${i==pageContact.number ? 'bg-indigo-600 text-white' : ''}"
                               class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <span th:text="${i+1}"></span>
                            </a>
                        </li>

                        <li th:unless="${pageContact.last}">
                            <a th:href="@{'/user/contacts?size='+${pageSize}+'&page='+${pageContact.number+1}}"
                               class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Next
                            </a>
                        </li>
                    </ul>
                </nav>

            </div>

        </div>

        <!-- Contact Modal -->
        <div data-th-replace="~{user/contact_modals :: contact}"></div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@linways/table-to-excel@1.0.4/dist/tableToExcel.min.js"></script>
<script data-th-src="@{'/js/contacts.js'}"></script>

<script>
    function changePageSize(size) {
        window.location.href = `/user/contacts?size=${size}&page=0`;
    }

    function exportData() {
        TableToExcel.convert(document.getElementById("contact-table"), {
            name: "contacts.xlsx",
            sheet: { name: "Sheet 1" }
        });
    }
</script>

</body>
</html>
